<!-- TODO(quacht): move the CSS out to a separate file -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="target-densitydpi=device-dpi, height=660, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Blockly Demo: Block Factory</title>
  <script src="/storage.js"></script>
  <script src="../../blockly_uncompressed.js"></script>
  <script src="../../generators/javascript.js"></script>
  <script src="factory.js"></script>
  <script src="block_library_ui.js"></script>
  <script src="block_library_storage.js"></script>
  <script src="block_library.js"></script>
  <script src="block_library_exporter.js"></script>
  <script src="blocks.js"></script>
  <link rel="stylesheet" href="factory.css">
  <link rel="stylesheet" href="../prettify.css">
  <script src="../prettify.js"></script>
</head>
<body>
  <div id="exporterHiddenWorkspace" style="display: none"></div>
 <table>
    <tr>
      <td width="50%" height="5%">
        <h1><a href="https://developers.google.com/blockly/">Blockly</a> &gt;
          <a href="../index.html">Demos</a> &gt; Block Factory</h1>
      </td>
      <td width="50%" height="5%">
        <table>
          <tr id="blockLibrary">
            <td style="vertical-align: bottom;">
            <span>
              <h3>Block Library:</h3>
              <select id="blockLibraryDropdown" onChange="BlockLibrary.selectHandler(this);">
              </select>
            </span>
            </td>
            <td style="vertical-align: middle; text-align: right;">
            <button id="saveToBlockLibraryButton" title="Save block xml to a local file.">
              <span>Save to Block Library</span>
            </button>
            <button id="removeBlockFromLibraryButton" title="Remove block from library.">
              <span>Remove Current Block from Library</span>
            </button>
            <button id="clearBlockLibraryButton" title="Clear Block Library below.">
              <span>Clear Block Library</span>
            </button>
            </td>
          </tr>
          <tr>
            <td style="vertical-align: bottom;">
              <h3>Preview:
                <select id="direction">
                  <option value="ltr">LTR</option>
                  <option value="rtl">RTL</option>
                </select>
              </h3>
            </td>
            <td style="vertical-align: middle; text-align: right;">
              <button id="linkButton" title="Save and link to blocks.">
                <img src="link.png" height="21" width="21">
              </button>
              <button id="linkButton" title="Save and link to blocks.">
                <img src="link.png" height="21" width="21">
              </button>
              <button id="downloadFromLibButton" title="Download scripts for your block(s).">
                <span>Download From Library</span>
              </button>
              <label for="files" class="buttonStyle"> <span class=>Import block</span></label>
              <input style="visibility: hidden; position: absolute;" id="files"  type="file"
                     name="files" accept="application/xml">
              <button id="localSaveButton" title="Save block xml to a local file.">
                <span>Download block</span>
              </button>
              <button id="helpButton" title="View documentation in new window.">
                <span>Help</span>
              </button>
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td width="50%" height="95%" style="padding: 2px;">
        <div id="blockly"></div>
        <div id="blocklyMask"></div>
      </td>
      <td width="50%" height="95%">
        <table>
          <tr>
            <td height="30%">
              <div id="preview"></div>
            </td>
          </tr>
          <tr>
            <td height="5%">
              <h3>Language code:
                <select id="format">
                  <option value="JavaScript">JavaScript</option>
                  <option value="JSON">JSON</option>
                  <option value="Manual">Manual edit&hellip;</option>
                </select>
                <button class ="downloadButton" id="downloadBlocks"
                        title="Download block definition to a file.">
                 <span>Download</span>
               </button>
              </h3>
            </td>
          </tr>
          <tr>
            <td height="30%">
              <pre id="languagePre"></pre>
              <textarea id="languageTA"></textarea>
            </td>
          </tr>
          <tr>
            <td height="5%">
              <h3>Generator stub:
                <select id="language">
                  <option value="JavaScript">JavaScript</option>
                  <option value="Python">Python</option>
                  <option value="PHP">PHP</option>
                  <option value="Lua">Lua</option>
                  <option value="Dart">Dart</option>
                </select>
                <button id="downloadGenerator" class="downloadButton"
                        title="Downloadgenerator stub to a file.">
                  <span>Download</span>
                </button>
              </h3>
            </td>
          </tr>
          <tr>
            <td height="30%">
              <pre id="generatorPre"></pre>
            </td>
          </tr>
        </table>
      </td>
  </table>
  <xml id="toolbox" style="display: none">
    <category name="Input">
      <block type="input_value">
        <value name="TYPE">
          <shadow type="type_null"></shadow>
        </value>
      </block>
      <block type="input_statement">
        <value name="TYPE">
          <shadow type="type_null"></shadow>
        </value>
      </block>
      <block type="input_dummy"></block>
    </category>
    <category name="Field">
      <block type="field_static"></block>
      <block type="field_input"></block>
      <block type="field_angle"></block>
      <block type="field_dropdown"></block>
      <block type="field_checkbox"></block>
      <block type="field_colour"></block>
      <!--
      Date picker commented out since it increases footprint by 60%.
      Add it only if you need it.  See also goog.require in blockly.js.
      <block type="field_date"></block>
      -->
      <block type="field_variable"></block>
      <block type="field_image"></block>
    </category>
    <category name="Type">
      <block type="type_group"></block>
      <block type="type_null"></block>
      <block type="type_boolean"></block>
      <block type="type_number"></block>
      <block type="type_string"></block>
      <block type="type_list"></block>
      <block type="type_other"></block>
    </category>
    <category name="Colour" id="colourCategory">
      <block type="colour_hue"><mutation colour="20"></mutation><field name="HUE">20</field></block>
      <block type="colour_hue"><mutation colour="65"></mutation><field name="HUE">65</field></block>
      <block type="colour_hue"><mutation colour="120"></mutation><field name="HUE">120</field></block>
      <block type="colour_hue"><mutation colour="160"></mutation><field name="HUE">160</field></block>
      <block type="colour_hue"><mutation colour="210"></mutation><field name="HUE">210</field></block>
      <block type="colour_hue"><mutation colour="230"></mutation><field name="HUE">230</field></block>
      <block type="colour_hue"><mutation colour="260"></mutation><field name="HUE">260</field></block>
      <block type="colour_hue"><mutation colour="290"></mutation><field name="HUE">290</field></block>
      <block type="colour_hue"><mutation colour="330"></mutation><field name="HUE">330</field></block>
    </category>
  </xml>
  <script>
  /**
   * Initialize Blockly and layout.  Called on page load.
   */
  function init() {
    if ('BlocklyStorage' in window) {
      BlocklyStorage.HTTPREQUEST_ERROR =
          'There was a problem with the request.\n';
      BlocklyStorage.LINK_ALERT =
          'Share your blocks with this link:\n\n%1';
      BlocklyStorage.HASH_ERROR =
          'Sorry, "%1" doesn\'t correspond with any saved Blockly file.';
      BlocklyStorage.XML_ERROR = 'Could not load your saved file.\n' +
          'Perhaps it was created with a different version of Blockly?';
      var linkButton = document.getElementById('linkButton');
      linkButton.style.display = 'inline-block';
      linkButton.addEventListener('click',
          function() {BlocklyStorage.link(mainWorkspace);});
      disableEnableLink();
    }

    // Initialize Block Library and Exporter.
    BlockLibrary.name = 'blockLibrary';
    BlockLibrary.populateBlockLibrary(BlockLibrary.name);
    BlockLibrary.exporter =
        new BlockLibrary.Exporter('exporterHiddenWorkspace');

    // Assign button click handlers.
    document.getElementById('localSaveButton')
      .addEventListener('click', BlockLibrary.saveWorkspaceToFile);

    document.getElementById('saveToBlockLibraryButton')
      .addEventListener('click', BlockLibrary.saveToBlockLibrary);

    document.getElementById('clearBlockLibraryButton')
      .addEventListener('click', BlockLibrary.clearBlockLibrary);

    document.getElementById('removeBlockFromLibraryButton')
      .addEventListener('click', BlockLibrary.removeFromBlockLibrary);

    document.getElementById('downloadFromLibButton')
      .addEventListener('click', BlockLibrary.downloadBlockFiles);

    document.getElementById('files').addEventListener('change',
      function() {
        importBlockFromFile();
        // Clear this so that the change event still fires even if the
        // same file is chosen again. If the user re-imports a file, we
        // want to reload the workspace with its contents.
        this.value = null;
      });

    document.getElementById('helpButton').addEventListener('click',
      function() {
        open('https://developers.google.com/blockly/custom-blocks/block-factory',
             'BlockFactoryHelp');
      });
    document.getElementById('downloadBlocks').addEventListener('click',
      function() {
        downloadTextArea('blocks', 'languagePre');
      });

    document.getElementById('downloadGenerator').addEventListener('click',
      function() {
        downloadTextArea('generator', 'generatorPre');
      });

    var expandList = [
      document.getElementById('blockly'),
      document.getElementById('blocklyMask'),
      document.getElementById('preview'),
      document.getElementById('languagePre'),
      document.getElementById('languageTA'),
      document.getElementById('generatorPre')
    ];
    var onresize = function(e) {
      for (var i = 0, expand; expand = expandList[i]; i++) {
        expand.style.width = (expand.parentNode.offsetWidth - 2) + 'px';
        expand.style.height = (expand.parentNode.offsetHeight - 2) + 'px';
      }
    };
    onresize();
    window.addEventListener('resize', onresize);

    var toolbox = document.getElementById('toolbox');
    mainWorkspace = Blockly.inject('blockly',
        {collapse: false,
         toolbox: toolbox,
         media: '../../media/'});

    // Create the root block.
    if ('BlocklyStorage' in window && window.location.hash.length > 1) {
      BlocklyStorage.retrieveXml(window.location.hash.substring(1),
                                 mainWorkspace);
    } else {
      var xml = '<xml><block type="factory_base" deletable="false" ' +
          'movable="false"></block></xml>';
      Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(xml), mainWorkspace);
    }
    mainWorkspace.clearUndo();

    mainWorkspace.addChangeListener(updateLanguage);
    document.getElementById('direction')
        .addEventListener('change', updatePreview);
    document.getElementById('languageTA')
        .addEventListener('change', updatePreview);
    document.getElementById('languageTA')
        .addEventListener('keyup', updatePreview);
    document.getElementById('format')
        .addEventListener('change', formatChange);
    document.getElementById('language')
        .addEventListener('change', updatePreview);
  }
  window.addEventListener('load', init);
  </script>
</body>
</html>